# Development Dockerfile for notifications-service with Air hot reloading
FROM golang:1.24-alpine

# Install build dependencies and Air
RUN apk add --no-cache git make protoc protobuf-dev curl && \
    go install github.com/cosmtrek/air@v1.49.0

WORKDIR /workspace

# Create the proper directory structure
RUN mkdir -p /workspace/metargb/notifications-service /workspace/metargb/shared

# Copy go.mod files first for dependency caching
COPY ./shared/go.mod /workspace/metargb/shared/
COPY ./services/notifications-service/go.mod ./services/notifications-service/go.sum* /workspace/metargb/notifications-service/

# Setup go workspace
WORKDIR /workspace
RUN echo 'go 1.24.0' > go.work && \
    echo '' >> go.work && \
    echo 'use (' >> go.work && \
    echo '    ./metargb/notifications-service' >> go.work && \
    echo '    ./metargb/shared' >> go.work && \
    echo ')' >> go.work

# Download dependencies (cached layer, only invalidated when go.mod changes)
WORKDIR /workspace/metargb/notifications-service
RUN sed -i 's|replace metargb/shared => ../../shared|replace metargb/shared => /workspace/metargb/shared|g' go.mod || true

ENV GOPROXY=https://goproxy.io,direct
ENV GOWORK=/workspace/go.work
RUN go mod download

# Copy shared module source (for development, will be overridden by volume mount)
COPY ./shared/ /workspace/metargb/shared/
COPY ./services/notifications-service/ /workspace/metargb/notifications-service/

# Fix replace directive again after copying source
RUN sed -i 's|replace metargb/shared => ../../shared|replace metargb/shared => /workspace/metargb/shared|g' go.mod || true

# Ensure Air binary is in PATH
ENV PATH="${PATH}:/root/go/bin"

# Create tmp directory for Air builds
RUN mkdir -p /workspace/tmp

# Expose gRPC port
EXPOSE 50058

# Default command (can be overridden in docker-compose)
CMD ["air", "-c", "/workspace/metargb/notifications-service/.air.toml"]