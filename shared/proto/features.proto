syntax = "proto3";

package features;

import "common.proto";
import "google/protobuf/empty.proto";

option go_package = "metargb/shared/pb/features";

// FeatureService handles feature CRUD operations
service FeatureService {
  rpc ListFeatures(ListFeaturesRequest) returns (FeaturesResponse);
  rpc GetFeature(GetFeatureRequest) returns (FeatureResponse);
  rpc UpdateFeature(UpdateFeatureRequest) returns (FeatureResponse);
  rpc AddFeatureImages(AddFeatureImagesRequest) returns (FeatureResponse);
  rpc GetMyFeatures(GetMyFeaturesRequest) returns (FeaturesResponse);
  // My Features API endpoints
  rpc ListMyFeatures(ListMyFeaturesRequest) returns (ListMyFeaturesResponse);
  rpc GetMyFeature(GetMyFeatureRequest) returns (FeatureResponse);
  rpc AddMyFeatureImages(AddMyFeatureImagesRequest) returns (FeatureResponse);
  rpc RemoveMyFeatureImage(RemoveMyFeatureImageRequest) returns (google.protobuf.Empty);
  rpc UpdateMyFeature(UpdateMyFeatureRequest) returns (google.protobuf.Empty);
}

// FeatureMarketplaceService handles buying/selling features
service FeatureMarketplaceService {
  rpc BuyFeature(BuyFeatureRequest) returns (BuyFeatureResponse);
  rpc SendBuyRequest(SendBuyRequestRequest) returns (BuyRequestResponse);
  rpc AcceptBuyRequest(AcceptBuyRequestRequest) returns (BuyRequestResponse);
  rpc CreateSellRequest(CreateSellRequestRequest) returns (SellRequestResponse);
  rpc ListSellRequests(ListSellRequestsRequest) returns (SellRequestsResponse);
  rpc DeleteSellRequest(DeleteSellRequestRequest) returns (google.protobuf.Empty);
  rpc RequestGracePeriod(RequestGracePeriodRequest) returns (GracePeriodResponse);
  rpc ListBuyRequests(ListBuyRequestsRequest) returns (BuyRequestsResponse);
  rpc ListReceivedBuyRequests(ListReceivedBuyRequestsRequest) returns (BuyRequestsResponse);
  rpc RejectBuyRequest(RejectBuyRequestRequest) returns (google.protobuf.Empty);
  rpc DeleteBuyRequest(DeleteBuyRequestRequest) returns (google.protobuf.Empty);
  rpc UpdateGracePeriod(UpdateGracePeriodRequest) returns (google.protobuf.Empty);
}

// Messages

message ListFeaturesRequest {
  repeated string points = 1; // bbox coordinates
  bool load_buildings = 2;
  bool user_features_location = 3;
}

message FeaturesResponse {
  repeated Feature features = 1;
}

message GetFeatureRequest {
  uint64 feature_id = 1;
}

message FeatureResponse {
  Feature feature = 1;
}

message UpdateFeatureRequest {
  uint64 feature_id = 1;
  FeatureProperties properties = 2;
}

message AddFeatureImagesRequest {
  uint64 feature_id = 1;
  repeated string image_urls = 2;
}

message GetMyFeaturesRequest {
  uint64 user_id = 1;
}

// My Features API Messages
message ListMyFeaturesRequest {
  uint64 user_id = 1; // Authenticated user ID
  int32 page = 2; // Page number (default: 1)
}

message ListMyFeaturesResponse {
  repeated Feature data = 1;
  PaginationLinks links = 2;
  SimplePaginationMeta meta = 3;
}

message GetMyFeatureRequest {
  uint64 user_id = 1; // User ID from path (for scoped binding)
  uint64 feature_id = 2; // Feature ID (must belong to user_id)
}

message AddMyFeatureImagesRequest {
  uint64 user_id = 1; // User ID from path (for scoped binding)
  uint64 feature_id = 2; // Feature ID (must belong to user_id)
  repeated bytes image_data = 3; // Image file data (PNG, JPG, BMP, â‰¤1024 KB each)
  repeated string filenames = 4; // Original filenames
  repeated string content_types = 5; // MIME types
}

message RemoveMyFeatureImageRequest {
  uint64 user_id = 1; // User ID from path (for scoped binding)
  uint64 feature_id = 2; // Feature ID (must belong to user_id)
  uint64 image_id = 3; // Image ID (must belong to feature_id)
}

message UpdateMyFeatureRequest {
  uint64 user_id = 1; // User ID from path (for scoped binding)
  uint64 feature_id = 2; // Feature ID (must belong to user_id)
  int32 minimum_price_percentage = 3; // Required, min:80 (min:110 if user is under 18)
}

// Pagination messages (simple pagination - no total counts)
message PaginationLinks {
  string first = 1;
  string last = 2;
  string prev = 3;
  string next = 4;
}

message SimplePaginationMeta {
  int32 current_page = 1;
  string path = 2;
  int32 per_page = 3;
}

message Feature {
  uint64 id = 1;
  uint64 map_id = 2;
  uint64 owner_id = 3;
  string type = 4;
  FeatureProperties properties = 5;
  Geometry geometry = 6;
  repeated Image images = 7;
  bool is_owned_by_auth_user = 8;
  Seller seller = 9; // Latest seller from trade
  bool is_hourly_profit_active = 10;
  repeated Building building_models = 11; // Building models with pivot metadata
}

message Seller {
  uint64 id = 1;
  string name = 2;
  string code = 3;
}

message FeatureProperties {
  string id = 1; // VARCHAR PK
  string address = 2;
  int32 density = 3;
  string date = 4;
  string stability = 5; // as string
  string label = 6;
  string area = 7; // as string
  int32 region = 8;
  string karbari = 9;
  string center = 10;
  string owner = 11;
  string rgb = 12;
  string price_psc = 13; // VARCHAR, kept as string
  string price_irr = 14; // VARCHAR, kept as string
  int32 minimum_price_percentage = 15;
}

message Geometry {
  uint64 id = 1;
  uint64 feature_id = 2;
  string type = 3;
  repeated Coordinate coordinates = 4;
}

message Coordinate {
  uint64 id = 1;
  uint64 geometry_id = 2;
  string x = 3; // as string to preserve precision
  string y = 4; // as string to preserve precision
}

message Image {
  uint64 id = 1;
  string url = 2;
}

message BuyFeatureRequest {
  uint64 feature_id = 1;
  uint64 buyer_id = 2;
  string price_psc = 3;
  string price_irr = 4;
}

message BuyFeatureResponse {
  bool success = 1;
  string message = 2;
  Feature feature = 3;
}

message SendBuyRequestRequest {
  uint64 feature_id = 1;
  uint64 buyer_id = 2;
  string price_psc = 3;
  string price_irr = 4;
  string note = 5;
}

message BuyRequestResponse {
  uint64 id = 1;
  BuyerInfo buyer = 2;
  SellerInfo seller = 3;
  uint64 feature_id = 4;
  int32 status = 5;
  string note = 6;
  string price_psc = 7;
  string price_irr = 8;
  FeatureProperties feature_properties = 9;
  repeated Coordinate feature_coordinates = 10;
  string requested_grace_period = 11;
  string created_at = 12;
}

message BuyerInfo {
  uint64 id = 1;
  string code = 2;
  string profile_photo = 3; // URL to latest profile photo
}

message SellerInfo {
  uint64 id = 1;
  string code = 2;
}

message ListBuyRequestsRequest {
  uint64 buyer_id = 1;
}

message ListReceivedBuyRequestsRequest {
  uint64 seller_id = 1;
}

message BuyRequestsResponse {
  repeated BuyRequestResponse buy_requests = 1;
}

message RejectBuyRequestRequest {
  uint64 request_id = 1;
  uint64 seller_id = 2;
}

message DeleteBuyRequestRequest {
  uint64 request_id = 1;
  uint64 buyer_id = 2;
}

message UpdateGracePeriodRequest {
  uint64 request_id = 1;
  uint64 seller_id = 2;
  int32 grace_period_days = 3; // 1-30
}

message AcceptBuyRequestRequest {
  uint64 request_id = 1;
  uint64 seller_id = 2;
}

message CreateSellRequestRequest {
  uint64 feature_id = 1;
  uint64 seller_id = 2;
  string price_psc = 3; // Optional, mutually exclusive with minimum_price_percentage
  string price_irr = 4; // Optional, mutually exclusive with minimum_price_percentage
  int32 minimum_price_percentage = 5; // Optional, mutually exclusive with price_psc/price_irr, min:80 (min:110 if under 18)
}

message ListSellRequestsRequest {
  uint64 seller_id = 1; // Required - authenticated seller
}

message DeleteSellRequestRequest {
  uint64 sell_request_id = 1; // Required
  uint64 seller_id = 2; // Required - for authorization
}

message SellRequestResponse {
  uint64 id = 1;
  uint64 seller_id = 2;
  uint64 feature_id = 3;
  string price_psc = 4;
  string price_irr = 5;
  int32 status = 6; // 0 = open, 1 = closed
  string created_at = 7;
  FeatureProperties feature_properties = 8; // Eager loaded feature properties
  repeated Coordinate feature_coordinates = 9; // Eager loaded coordinates
}

message SellRequestsResponse {
  repeated SellRequestResponse sell_requests = 1;
}

message RequestGracePeriodRequest {
  uint64 request_id = 1;
  uint64 buyer_id = 2;
  string grace_period = 3; // Deprecated - use UpdateGracePeriod instead
}

message GracePeriodResponse {
  bool approved = 1;
  string message = 2;
}

// FeatureProfitService handles hourly profit calculations
service FeatureProfitService {
  rpc GetHourlyProfits(GetHourlyProfitsRequest) returns (HourlyProfitsResponse);
  rpc GetSingleProfit(GetSingleProfitRequest) returns (HourlyProfitResponse);
  rpc GetProfitsByApplication(GetProfitsByApplicationRequest) returns (ProfitsByApplicationResponse);
}

// BuildingService handles building construction
service BuildingService {
  rpc GetBuildPackage(GetBuildPackageRequest) returns (BuildPackageResponse);
  rpc BuildFeature(BuildFeatureRequest) returns (BuildFeatureResponse);
  rpc GetBuildings(GetBuildingsRequest) returns (BuildingsResponse);
  rpc UpdateBuilding(UpdateBuildingRequest) returns (BuildingResponse);
  rpc DestroyBuilding(DestroyBuildingRequest) returns (BuildingResponse);
}

// Hourly Profit Messages

message GetHourlyProfitsRequest {
  uint64 user_id = 1;
  int32 page = 2;
  int32 page_size = 3;
}

message HourlyProfitsResponse {
  repeated HourlyProfit profits = 1;
  string total_maskoni_profit = 2;
  string total_tejari_profit = 3;
  string total_amozeshi_profit = 4;
}

message HourlyProfit {
  uint64 id = 1;
  uint64 feature_id = 2;
  uint64 user_id = 3;
  string asset = 4; // color: yellow, red, blue
  string amount = 5; // formatted as string
  string dead_line = 6; // timestamp
  bool is_active = 7;
}

message GetSingleProfitRequest {
  uint64 profit_id = 1;
  uint64 user_id = 2;
}

message HourlyProfitResponse {
  HourlyProfit profit = 1;
  bool success = 2;
}

message GetProfitsByApplicationRequest {
  uint64 user_id = 1;
  string karbari = 2; // m, t, a
}

message ProfitsByApplicationResponse {
  string total_amount = 1;
  bool success = 2;
}

// Building Messages

message GetBuildPackageRequest {
  uint64 feature_id = 1;
  int32 page = 2;
}

message BuildPackageResponse {
  repeated BuildingModel models = 1;
  repeated string coordinates = 2;
}

message BuildingModel {
  uint64 id = 1;
  string model_id = 2;
  string name = 3;
  string sku = 4;
  string images = 5; // JSON array
  string attributes = 6; // JSON array
  string file = 7; // JSON object
  string required_satisfaction = 8;
}

message BuildFeatureRequest {
  uint64 feature_id = 1;
  uint64 building_model_id = 2;
  string launched_satisfaction = 3;
  string rotation = 4;
  string position = 5;
  BuildingInformation information = 6;
}

message BuildingInformation {
  string activity_line = 1;
  string name = 2;
  string address = 3;
  string postal_code = 4;
  string website = 5;
  string description = 6;
}

message BuildFeatureResponse {
  bool success = 1;
  string message = 2;
}

message GetBuildingsRequest {
  uint64 feature_id = 1;
}

message BuildingsResponse {
  repeated Building buildings = 1;
}

message Building {
  uint64 id = 1;
  BuildingModel model = 2;
  string construction_start_date = 3;
  string construction_end_date = 4;
  string launched_satisfaction = 5;
  string rotation = 6;
  string position = 7;
  string bubble_diameter = 8;
  string information = 9; // JSON
}

message UpdateBuildingRequest {
  uint64 feature_id = 1;
  uint64 building_model_id = 2;
  string launched_satisfaction = 3;
  string rotation = 4;
  string position = 5;
  BuildingInformation information = 6;
}

message BuildingResponse {
  bool success = 1;
  string message = 2;
  Building building = 3;
}

message DestroyBuildingRequest {
  uint64 feature_id = 1;
  uint64 building_model_id = 2;
}

// MapsService handles map polygon and feature rollup operations
service MapsService {
  rpc ListMaps(ListMapsRequest) returns (ListMapsResponse);
  rpc GetMap(GetMapRequest) returns (GetMapResponse);
  rpc GetMapBorder(GetMapRequest) returns (GetMapBorderResponse);
}

// Maps Messages

message ListMapsRequest {
  // Empty request for listing all maps
}

message GetMapRequest {
  uint64 map_id = 1;
}

message ListMapsResponse {
  repeated Map maps = 1;
}

message GetMapResponse {
  Map map = 1;
}

message GetMapBorderResponse {
  MapBorderData data = 1;
}

message MapBorderData {
  string border_coordinates = 1; // JSON string
}

message Map {
  uint64 id = 1;
  string name = 2;
  string color = 3; // polygon_color
  string central_point_coordinates = 4; // JSON string
  string sold_features_percentage = 5; // formatted to 2 decimal places
  // Additional fields for detail view
  string border_coordinates = 6; // JSON string (only in detail)
  uint64 area = 7; // polygon_area (only in detail)
  string address = 8; // polygon_address (only in detail)
  string published_at = 9; // publish_date (only in detail)
  MapFeatures features = 10; // grouping by karbari (only in detail)
}

message MapFeatures {
  MapFeatureCount maskoni = 1;
  MapFeatureCount tejari = 2;
  MapFeatureCount amoozeshi = 3;
}

message MapFeatureCount {
  int32 sold = 1; // count of features with owner_id != 1 and matching karbari
}

