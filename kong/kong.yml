_format_version: "3.0"

# ============================================================================
# MetaRGB API Gateway Configuration
# ============================================================================
# This file maps HTTP REST endpoints to gRPC microservices.
#
# IMPORTANT: REST to gRPC Translation
# ------------------------------------
# Kong does NOT automatically translate REST/JSON requests to gRPC/protobuf.
# The current configuration routes REST requests to gRPC endpoints, but
# requires a translation layer to convert JSON to protobuf format.
#
# Options for REST to gRPC translation:
# 1. Deploy a gRPC-Gateway service (recommended)
# 2. Add HTTP annotations to proto files and generate gateway code
# 3. Modify services to accept both REST/JSON and gRPC
#
# See docs/KONG_REST_TO_GRPC.md for detailed implementation guide.
# ============================================================================

services:
  # ============================================================================
  # Auth Service - Authentication & User Management
  # ============================================================================
  # NOTE: Kong does not automatically translate REST/JSON to gRPC/protobuf.
  # For full REST to gRPC translation, you need either:
  # 1. A gRPC-Gateway service (recommended) that handles JSONâ†”protobuf conversion
  # 2. HTTP annotations in proto files using gRPC-Gateway tool
  # 3. Custom transformation plugins
  #
  # Current configuration routes REST requests to gRPC endpoints.
  # The service layer should handle JSON/protobuf conversion or use a gateway.

  # ============================================================================
  # gRPC Gateway Service - REST to gRPC Translation
  # Routes REST/JSON requests through gateway service for translation to gRPC
  # ============================================================================
  - name: grpc-gateway-service
    url: http://grpc-gateway:8080
    protocol: http
    routes:
      # Auth endpoints (No authentication required)
      - name: auth-register-route
        paths:
          - /api/auth/register
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
      - name: auth-redirect-route
        paths:
          - /api/auth/redirect
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
      - name: auth-callback-route
        paths:
          - /api/auth/callback
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
      - name: auth-me-route
        paths:
          - /api/auth/me
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: auth-logout-route
        paths:
          - /api/auth/logout
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: auth-validate-token-route
        paths:
          - /api/auth/validate
          - /api/auth/token/validate
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        # Validate token endpoint doesn't require JWT (it validates tokens itself)
      - name: auth-request-security-route
        paths:
          - /api/auth/account-security/request
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: auth-verify-security-route
        paths:
          - /api/auth/account-security/verify
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # User endpoints
      - name: user-get-route
        paths:
          - /api/user
          - /api/users
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: user-update-route
        paths:
          - /api/user/profile
        methods:
          - PUT
          - PATCH
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # KYC endpoints
      - name: kyc-submit-route
        paths:
          - /api/kyc/submit
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: kyc-status-route
        paths:
          - /api/kyc/status
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: kyc-bank-route
        paths:
          - /api/kyc/bank-account
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
    plugins:
      - name: cors
      - name: rate-limiting
        config:
          minute: 100
          hour: 2000

  # ============================================================================
  # Commercial Service (Wallet & Transactions)
  # NOTE: Requires REST to gRPC translation layer - see docs/KONG_REST_TO_GRPC.md
  # ============================================================================
  - name: commercial-service
    url: grpc://commercial-service:50052
    protocol: grpc
    routes:
      - name: wallet-routes
        paths:
          - /api/user/wallet
          - /api/user/transactions
        strip_path: false
        protocols:
          - http
          - https
      - name: payment-routes
        paths:
          - /api/order
          - /api/parsian/callback
        strip_path: false
        protocols:
          - http
          - https
    plugins:
      - name: cors
      - name: jwt
        config:
          uri_param_names:
            - token
          header_names:
            - Authorization
          cookie_names:
            - token
      - name: rate-limiting
        config:
          minute: 60
          hour: 1000

  # ============================================================================
  # Features Service
  # NOTE: Requires REST to gRPC translation layer - see docs/KONG_REST_TO_GRPC.md
  # ============================================================================
  - name: features-service
    url: grpc://features-service:50053
    protocol: grpc
    routes:
      - name: features-routes
        paths:
          - /api/features
          - /api/my-features
        strip_path: false
        protocols:
          - http
          - https
      - name: buy-requests-routes
        paths:
          - /api/buy-requests
        strip_path: false
        protocols:
          - http
          - https
      - name: sell-requests-routes
        paths:
          - /api/sell-requests
        strip_path: false
        protocols:
          - http
          - https
      - name: hourly-profits-routes
        paths:
          - /api/hourly-profits
        strip_path: false
        protocols:
          - http
          - https
    plugins:
      - name: cors
      - name: jwt
        config:
          uri_param_names:
            - token
          header_names:
            - Authorization
          cookie_names:
            - token
      - name: rate-limiting
        config:
          minute: 100
          hour: 5000

  # ============================================================================
  # Dynasty Service
  # NOTE: Requires REST to gRPC translation layer - see docs/KONG_REST_TO_GRPC.md
  # ============================================================================
  - name: dynasty-service
    url: grpc://dynasty-service:50055
    protocol: grpc
    routes:
      - name: dynasty-routes
        paths:
          - /api/dynasty
        strip_path: false
        protocols:
          - http
          - https
    plugins:
      - name: cors
      - name: jwt
        config:
          uri_param_names:
            - token
          header_names:
            - Authorization
          cookie_names:
            - token
      - name: rate-limiting
        config:
          minute: 60
          hour: 2000

  # ============================================================================
  # Support Service
  # NOTE: Requires REST to gRPC translation layer - see docs/KONG_REST_TO_GRPC.md
  # ============================================================================
  - name: support-service
    url: grpc://support-service:50056
    protocol: grpc
    routes:
      - name: support-routes
        paths:
          - /api/tickets
          - /api/reports
          - /api/events
        strip_path: false
        protocols:
          - http
          - https
    plugins:
      - name: cors
      - name: jwt
        config:
          uri_param_names:
            - token
          header_names:
            - Authorization
          cookie_names:
            - token
      - name: rate-limiting
        config:
          minute: 50
          hour: 1000

  # ============================================================================
  # Training Service
  # NOTE: Requires REST to gRPC translation layer - see docs/KONG_REST_TO_GRPC.md
  # ============================================================================
  - name: training-service
    url: grpc://training-service:50057
    protocol: grpc
    routes:
      - name: training-routes
        paths:
          - /api/v2/tutorials
          - /api/tutorials
        strip_path: false
        protocols:
          - http
          - https
    plugins:
      - name: cors
      - name: jwt
        config:
          uri_param_names:
            - token
          header_names:
            - Authorization
          cookie_names:
            - token
      - name: rate-limiting
        config:
          minute: 100
          hour: 3000

  # ============================================================================
  # Notifications Service
  # NOTE: Requires REST to gRPC translation layer - see docs/KONG_REST_TO_GRPC.md
  # ============================================================================
  - name: notifications-service
    url: grpc://notifications-service:50060
    protocol: grpc
    routes:
      - name: notifications-routes
        paths:
          - /api/notifications
        strip_path: false
        protocols:
          - http
          - https
    plugins:
      - name: cors
      - name: jwt
        config:
          uri_param_names:
            - token
          header_names:
            - Authorization
          cookie_names:
            - token
      - name: rate-limiting
        config:
          minute: 100
          hour: 2000

  # ============================================================================
  # Calendar Service
  # NOTE: Requires REST to gRPC translation layer - see docs/KONG_REST_TO_GRPC.md
  # ============================================================================
  - name: calendar-service
    url: grpc://calendar-service:50058
    protocol: grpc
    routes:
      - name: calendar-routes
        paths:
          - /api/calendar
        strip_path: false
        protocols:
          - http
          - https
    plugins:
      - name: cors
      - name: rate-limiting
        config:
          minute: 100
          hour: 3000

  # Health Check Service - System Health Monitoring
  - name: health-check-service
    url: http://health-check-service:8090
    protocol: http
    routes:
      - name: health-check-route
        paths:
          - /health
          - /api/health
        methods:
          - GET
        strip_path: false
    plugins:
      - name: cors

  # Phase 5: Storage Service (File Uploads)
  # Public upload endpoint (no auth required)
  - name: storage-service-upload
    url: http://storage-service:8059
    protocol: http
    routes:
      - name: upload-route
        paths:
          - /api/upload
        methods:
          - POST
          - OPTIONS
        strip_path: true
    plugins:
      - name: cors
      - name: request-size-limiting
        config:
          allowed_payload_size: 100 # 100MB for file uploads
      - name: rate-limiting
        config:
          minute: 50
          hour: 1000

  # ============================================================================
  # Storage Service (Protected endpoints - auth required)
  # NOTE: Requires REST to gRPC translation layer - see docs/KONG_REST_TO_GRPC.md
  # ============================================================================
  - name: storage-service
    url: grpc://storage-service:50059
    protocol: grpc
    routes:
      - name: storage-routes
        paths:
          - /api/files
          - /api/images
        strip_path: false
        protocols:
          - http
          - https
    plugins:
      - name: cors
      - name: jwt
        config:
          uri_param_names:
            - token
          header_names:
            - Authorization
          cookie_names:
            - token
      - name: request-size-limiting
        config:
          allowed_payload_size: 100 # 100MB for file uploads
      - name: rate-limiting
        config:
          minute: 30
          hour: 500

# Global Plugins
plugins:
  # CORS for all services
  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - PATCH
        - OPTIONS
      headers:
        - Accept
        - Accept-Version
        - Content-Length
        - Content-MD5
        - Content-Type
        - Date
        - Authorization
      exposed_headers:
        - X-Auth-Token
        - X-Request-ID
      credentials: true
      max_age: 3600

  # Request ID tracking (removed - needs to be enabled in Kong config)
  # - name: request-id
  #   config:
  #     header_name: X-Request-ID
  #     generator: uuid
  #     echo_downstream: true

  # Response headers
  - name: response-transformer
    config:
      add:
        headers:
          - "X-Powered-By: MetaRGB Microservices"
          - "X-Version: 1.0.0"

  # Global rate limiting (per IP)
  - name: rate-limiting
    config:
      minute: 300
      hour: 10000
      policy: redis
      redis_host: redis
      redis_port: 6379
      fault_tolerant: true

# Upstreams for load balancing (if needed)
upstreams:
  - name: auth-service-upstream
    algorithm: round-robin
    hash_on: none
    targets:
      - target: auth-service:50051
        weight: 100

  - name: features-service-upstream
    algorithm: least-connections
    hash_on: consumer
    targets:
      - target: features-service:50053
        weight: 100

# Consumer management (for API keys if needed)
# Note: Consumer plugins should be configured at the service/route level, not consumer level
consumers:
  - username: admin
    custom_id: admin-user

