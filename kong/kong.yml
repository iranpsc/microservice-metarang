_format_version: "3.0"

# ============================================================================
# MetaRGB API Gateway Configuration
# ============================================================================
# This file maps HTTP REST endpoints to gRPC microservices.
#
# IMPORTANT: REST to gRPC Translation
# ------------------------------------
# Kong does NOT automatically translate REST/JSON requests to gRPC/protobuf.
# The current configuration routes REST requests to gRPC endpoints, but
# requires a translation layer to convert JSON to protobuf format.
#
# Options for REST to gRPC translation:
# 1. Deploy a gRPC-Gateway service (recommended)
# 2. Add HTTP annotations to proto files and generate gateway code
# 3. Modify services to accept both REST/JSON and gRPC
#
# See docs/KONG_REST_TO_GRPC.md for detailed implementation guide.
# ============================================================================

services:
  # ============================================================================
  # Auth Service - Authentication & User Management
  # ============================================================================
  # NOTE: Kong does not automatically translate REST/JSON to gRPC/protobuf.
  # For full REST to gRPC translation, you need either:
  # 1. A gRPC-Gateway service (recommended) that handles JSON↔protobuf conversion
  # 2. HTTP annotations in proto files using gRPC-Gateway tool
  # 3. Custom transformation plugins
  #
  # Current configuration routes REST requests to gRPC endpoints.
  # The service layer should handle JSON/protobuf conversion or use a gateway.

  # ============================================================================
  # gRPC Gateway Service - REST to gRPC Translation
  # Routes REST/JSON requests through gateway service for translation to gRPC
  # ============================================================================
  - name: grpc-gateway-service
    url: http://grpc-gateway:8080
    protocol: http
    routes:
      # Auth endpoints (No authentication required)
      - name: auth-register-route
        paths:
          - /api/auth/register
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
      - name: auth-redirect-route
        paths:
          - /api/auth/redirect
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
      - name: auth-callback-route
        paths:
          - /api/auth/callback
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
      - name: auth-me-route
        paths:
          - /api/auth/me
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: auth-logout-route
        paths:
          - /api/auth/logout
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: auth-validate-token-route
        paths:
          - /api/auth/validate
          - /api/auth/token/validate
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        # Validate token endpoint doesn't require JWT (it validates tokens itself)
      # Search endpoints (No authentication required)
      - name: search-users-route
        paths:
          - /api/search/users
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
      - name: search-features-route
        paths:
          - /api/search/features
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
      - name: search-isic-codes-route
        paths:
          - /api/search/isic-codes
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
      - name: account-security-request-route
        paths:
          - /api/account/security
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: account-security-verify-route
        paths:
          - /api/account/security/verify
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # Citizen endpoints (Public - no authentication required)
      # Routes: /api/citizen/{code}, /api/citizen/{code}/referrals, /api/citizen/{code}/referrals/chart
      - name: citizen-routes
        paths:
          - /api/citizen
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoints
        # Rate limiting recommended for public endpoints to prevent scraping
        plugins:
          - name: rate-limiting
            config:
              minute: 100
              hour: 5000
      # User endpoints
      - name: user-get-route
        paths:
          - /api/user
          - /api/users
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: user-update-route
        paths:
          - /api/user/profile
        methods:
          - PUT
          - PATCH
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: users-list-route
        paths:
          - /api/users
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT - public endpoint (explicitly skips auth per API spec)
      - name: user-levels-route
        paths:
          - /api/users/{user}/levels
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT - public endpoint
      - name: user-profile-route
        paths:
          - /api/users/{user}/profile
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT - public endpoint (privacy filtering handled by service)
      - name: user-profile-limitations-route
        paths:
          - /api/user/profile-limitations
          - /api/users/{user}/profile-limitations
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: user-features-count-route
        paths:
          - /api/users/{user}/features/count
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT - public endpoint
      - name: user-wallet-route
        paths:
          - /api/users/{user}/wallet
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT - public endpoint (wallet service will handle auth if needed)
      # KYC endpoints
      - name: kyc-get-route
        paths:
          - /api/kyc
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: kyc-update-route
        paths:
          - /api/kyc
        methods:
          - PUT
          - PATCH
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
          - name: request-size-limiting
            config:
              allowed_payload_size: 10 # 10MB for file uploads (melli_card + video)
      # Bank Account endpoints (RESTful CRUD - matches Laravel API spec: /api/kyc/bank-accounts)
      - name: bank-accounts-list-create-route
        paths:
          - /api/kyc/bank-accounts
        methods:
          - GET
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: bank-accounts-detail-route
        paths:
          - /api/kyc/bank-accounts/
        methods:
          - GET
          - PUT
          - PATCH
          - DELETE
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # Citizen endpoints (public, no auth required)
      # Kong will match any path starting with /api/citizen/ and forward full path to gateway
      - name: citizen-routes
        paths:
          - /api/citizen
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
      # Personal Info endpoints
      - name: personal-info-get-route
        paths:
          - /api/personal-info
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: personal-info-update-route
        paths:
          - /api/personal-info
        methods:
          - PUT
          - PATCH
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # Profile Limitation endpoints
      - name: profile-limitation-create-route
        paths:
          - /api/profile-limitations
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: profile-limitation-update-route
        paths:
          - /api/profile-limitations/
        methods:
          - PUT
          - PATCH
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: profile-limitation-delete-route
        paths:
          - /api/profile-limitations/
        methods:
          - DELETE
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: profile-limitation-get-route
        paths:
          - /api/profile-limitations/
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # Profile Photo endpoints (matches Laravel API: /api/profilePhotos)
      - name: profile-photo-list-route
        paths:
          - /api/profilePhotos
          - /api/profile-photos
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: profile-photo-upload-route
        paths:
          - /api/profilePhotos
          - /api/profile-photos
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
          - name: request-size-limiting
            config:
              allowed_payload_size: 1 # 1MB for profile photos (per API spec: ≤1024 KB)
      - name: profile-photo-get-route
        paths:
          - /api/profilePhotos/
          - /api/profile-photos/
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: profile-photo-delete-route
        paths:
          - /api/profilePhotos/
          - /api/profile-photos/
        methods:
          - DELETE
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # Settings endpoints
      - name: settings-get-route
        paths:
          - /api/settings
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: settings-update-route
        paths:
          - /api/settings
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: settings-general-get-route
        paths:
          - /api/general-settings
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: settings-general-update-route
        paths:
          - ~^/api/general-settings/.*
          - /api/general-settings
        methods:
          - PUT
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: settings-privacy-get-route
        paths:
          - /api/privacy
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: settings-privacy-update-route
        paths:
          - /api/privacy
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # User Events endpoints (matches Laravel API: /api/events)
      - name: user-events-list-route
        paths:
          - /api/events
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: user-events-get-route
        paths:
          - /api/events/
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: user-events-report-route
        paths:
          - /api/events/report/
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: user-events-report-response-route
        paths:
          - /api/events/report/response/
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: user-events-report-close-route
        paths:
          - /api/events/report/close/
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # Calendar endpoints (Public - no authentication required except /interact)
      - name: calendar-list-route
        paths:
          - /api/calendar
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
      - name: calendar-get-route
        paths:
          - /api/calendar/
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
      - name: calendar-filter-route
        paths:
          - /api/calendar/filter
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
      - name: calendar-latest-version-route
        paths:
          - /api/calendar/latest-version
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
      - name: calendar-interact-route
        paths:
          - /api/calendar/events/
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
    plugins:
      - name: cors
      - name: rate-limiting
        config:
          minute: 100
          hour: 2000

  # ============================================================================
  # Commercial Service (Wallet & Transactions)
  # NOTE: Requires REST to gRPC translation layer - see docs/KONG_REST_TO_GRPC.md
  # ============================================================================
  - name: commercial-service
    url: grpc://commercial-service:50052
    protocol: grpc
    routes:
      - name: wallet-routes
        paths:
          - /api/user/wallet
          - /api/user/transactions
        strip_path: false
        protocols:
          - http
          - https
    plugins:
      - name: cors
      - name: jwt
        config:
          uri_param_names:
            - token
          header_names:
            - Authorization
          cookie_names:
            - token
      - name: rate-limiting
        config:
          minute: 60
          hour: 1000

  # ============================================================================
  # Financial Service (Orders & Store Packages)
  # Routes through gRPC Gateway for REST to gRPC translation
  # ============================================================================
  - name: financial-service
    url: http://grpc-gateway:8080
    protocol: http
    routes:
      # POST /api/order - Create order and get Parsian payment URL (requires auth)
      - name: order-create-route
        paths:
          - /api/order
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # POST /api/parsian/callback - Parsian payment callback (public)
      - name: parsian-callback-route
        paths:
          - /api/parsian/callback
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint for Parsian gateway
      # POST /api/store - Get store packages (public)
      - name: store-packages-route
        paths:
          - /api/store
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
    plugins:
      - name: cors
      - name: rate-limiting
        config:
          minute: 100
          hour: 5000

  # ============================================================================
  # Features Service - Routes through gRPC Gateway
  # ============================================================================
  - name: features-service
    url: http://grpc-gateway:8080
    protocol: http
    routes:
      # GET /api/features - Public (optional auth via activity middleware)
      - name: features-list-route
        paths:
          - /api/features
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint with optional authentication
      # GET /api/features/{feature} - Public (optional auth via activity middleware)
      - name: features-get-route
        paths:
          - /api/features/
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
      # POST /api/features/buy/{feature} - Requires authentication
      - name: features-buy-route
        paths:
          - /api/features/buy/
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # My Features API routes
      - name: features-my-features-list-route
        paths:
          - /api/my-features
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: features-my-features-detail-route
        paths:
          - /api/my-features/
        methods:
          - GET
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # GET /api/buy-requests - List buyer's buy requests
      - name: buy-requests-list-route
        paths:
          - /api/buy-requests
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # GET /api/buy-requests/recieved - List seller's received buy requests
      - name: buy-requests-received-route
        paths:
          - /api/buy-requests/recieved
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # POST /api/buy-requests/store/{feature} - Create buy request
      - name: buy-requests-store-route
        paths:
          - /api/buy-requests/store/
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # POST /api/buy-requests/accept/{buyFeatureRequest} - Accept buy request
      - name: buy-requests-accept-route
        paths:
          - /api/buy-requests/accept/
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # POST /api/buy-requests/reject/{buyFeatureRequest} - Reject buy request
      - name: buy-requests-reject-route
        paths:
          - /api/buy-requests/reject/
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # DELETE /api/buy-requests/delete/{buyFeatureRequest} - Delete buy request
      - name: buy-requests-delete-route
        paths:
          - /api/buy-requests/delete/
        methods:
          - DELETE
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # POST /api/buy-requests/add-grace-period/{buyFeatureRequest} - Update grace period
      - name: buy-requests-grace-period-route
        paths:
          - /api/buy-requests/add-grace-period/
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # GET /api/sell-requests - List seller's sell requests
      - name: sell-requests-list-route
        paths:
          - /api/sell-requests
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # POST /api/sell-requests/store/{feature} - Create sell request
      - name: sell-requests-store-route
        paths:
          - /api/sell-requests/store/
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # DELETE /api/sell-requests/{sellRequest} - Delete sell request
      - name: sell-requests-delete-route
        paths:
          - /api/sell-requests/
        methods:
          - DELETE
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # GET /api/v2/maps - Public (no authentication)
      - name: maps-list-route
        paths:
          - /api/v2/maps
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
      # GET /api/v2/maps/{map} - Public (no authentication)
      - name: maps-get-route
        paths:
          - /api/v2/maps/
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
      # GET /api/v2/maps/{map}/border - Public (no authentication)
      - name: maps-border-route
        paths:
          - /api/v2/maps/
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
      # Levels API (v2) - Public endpoints (no authentication required)
      # GET /api/v2/levels - List all levels
      - name: levels-list-route
        paths:
          - /api/v2/levels
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
      # GET /api/v2/levels/{slug} - Get level by slug
      - name: levels-get-route
        paths:
          - /api/v2/levels/
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
      # GET /api/v2/levels/{slug}/general-info - Get level general info
      - name: levels-general-info-route
        paths:
          - /api/v2/levels/
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
      # GET /api/v2/levels/{slug}/gem - Get level gem
      - name: levels-gem-route
        paths:
          - /api/v2/levels/
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
      # GET /api/v2/levels/{slug}/gift - Get level gift
      - name: levels-gift-route
        paths:
          - /api/v2/levels/
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
      # GET /api/v2/levels/{slug}/licenses - Get level licenses
      - name: levels-licenses-route
        paths:
          - /api/v2/levels/
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
      # GET /api/v2/levels/{slug}/prize - Get level prize
      - name: levels-prize-route
        paths:
          - /api/v2/levels/
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
      # GET /api/hourly-profits - List hourly profits with pagination and totals
      - name: hourly-profits-list-route
        paths:
          - /api/hourly-profits
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # POST /api/hourly-profits - Withdraw profits by karbari (m/t/a)
      - name: hourly-profits-by-application-route
        paths:
          - /api/hourly-profits
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # POST /api/hourly-profits/{featureHourlyProfit} - Withdraw single profit
      - name: hourly-profits-single-route
        paths:
          - /api/hourly-profits/
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # Building Feature API routes (v2)
      # GET /api/v2/features/{feature}/build/package - Get build package with models
      - name: features-build-package-route
        paths:
          - /api/v2/features/.*/build/package
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # POST /api/v2/features/{feature}/build/{buildingModel} - Start building construction
      - name: features-build-start-route
        paths:
          - /api/v2/features/.*/build/.*
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # GET /api/v2/features/{feature}/build/buildings - List buildings on feature
      - name: features-build-buildings-list-route
        paths:
          - /api/v2/features/.*/build/buildings
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # PUT /api/v2/features/{feature}/build/buildings/{buildingModel} - Update building
      - name: features-build-buildings-update-route
        paths:
          - /api/v2/features/.*/build/buildings/.*
        methods:
          - PUT
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # DELETE /api/v2/features/{feature}/build/buildings/{buildingModel} - Destroy building
      - name: features-build-buildings-delete-route
        paths:
          - /api/v2/features/.*/build/buildings/.*
        methods:
          - DELETE
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
    plugins:
      - name: cors
      - name: rate-limiting
        config:
          minute: 100
          hour: 5000

  # ============================================================================
  # Dynasty Service - Routes through gRPC Gateway
  # ============================================================================
  - name: dynasty-service
    url: http://grpc-gateway:8080
    protocol: http
    routes:
      - name: dynasty-routes
        paths:
          - /api/dynasty
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
    plugins:
      - name: cors
      - name: rate-limiting
        config:
          minute: 60
          hour: 2000

  # ============================================================================
  # Social Service - Routes through gRPC Gateway
  # ============================================================================
  - name: social-service
    url: http://grpc-gateway:8080
    protocol: http
    routes:
      - name: follow-routes
        paths:
          - /api/followers
          - /api/following
          - /api/follow
          - /api/unfollow
          - /api/remove
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: challenge-routes
        paths:
          - /api/challenge
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
    plugins:
      - name: cors
      - name: rate-limiting
        config:
          minute: 100
          hour: 5000

  # ============================================================================
  # Support Service - Routes through gRPC Gateway
  # ============================================================================
  - name: support-service
    url: http://grpc-gateway:8080
    protocol: http
    routes:
      # Tickets API
      - name: tickets-list-route
        paths:
          - /api/tickets
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: tickets-create-route
        paths:
          - /api/tickets
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: tickets-get-route
        paths:
          - /api/tickets/
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: tickets-update-route
        paths:
          - /api/tickets/
        methods:
          - PUT
          - PATCH
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: tickets-response-route
        paths:
          - /api/tickets/response/
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: tickets-close-route
        paths:
          - /api/tickets/close/
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # Reports API
      - name: reports-list-route
        paths:
          - /api/reports
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: reports-create-route
        paths:
          - /api/reports
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: reports-get-route
        paths:
          - /api/reports/
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # Notes API
      - name: notes-list-route
        paths:
          - /api/notes
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: notes-create-route
        paths:
          - /api/notes
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: notes-get-route
        paths:
          - /api/notes/
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: notes-update-route
        paths:
          - /api/notes/
        methods:
          - PUT
          - PATCH
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: notes-delete-route
        paths:
          - /api/notes/
        methods:
          - DELETE
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
    plugins:
      - name: cors
      - name: rate-limiting
        config:
          minute: 50
          hour: 1000

  # ============================================================================
  # Training Service (Video Tutorials) - Routes through gRPC Gateway
  # ============================================================================
  - name: training-service
    url: http://grpc-gateway:8080
    protocol: http
    routes:
      # Public video tutorial endpoints
      - name: tutorials-list-route
        paths:
          - /api/v2/tutorials
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
      - name: tutorials-get-route
        paths:
          - /api/v2/tutorials/
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
      - name: tutorials-search-route
        paths:
          - /api/v2/tutorials/search
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
      - name: tutorials-interactions-route
        paths:
          - /api/v2/tutorials/.*/interactions
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # Public category endpoints
      - name: tutorials-categories-list-route
        paths:
          - /api/v2/tutorials/categories
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
      - name: tutorials-category-get-route
        paths:
          - /api/v2/tutorials/categories/
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
      - name: tutorials-category-videos-route
        paths:
          - /api/v2/tutorials/categories/.*/videos
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
      - name: tutorials-subcategory-route
        paths:
          - /api/v2/tutorials/categories/.*/.*
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
      # Public v1 modal lookup endpoint
      - name: tutorials-modal-route
        paths:
          - /api/video-tutorials
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
      # Comment endpoints
      - name: tutorials-comments-list-route
        paths:
          - /api/v2/tutorials/.*/comments
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
      - name: tutorials-comments-create-route
        paths:
          - /api/v2/tutorials/.*/comments
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: tutorials-comments-update-route
        paths:
          - /api/v2/tutorials/.*/comments/.*
        methods:
          - PUT
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: tutorials-comments-delete-route
        paths:
          - /api/v2/tutorials/.*/comments/.*
        methods:
          - DELETE
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: tutorials-comments-interactions-route
        paths:
          - /api/v2/tutorials/.*/comments/.*/interactions
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: tutorials-comments-report-route
        paths:
          - /api/v2/tutorials/.*/comments/.*/report
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      # Reply endpoints
      - name: tutorials-replies-list-route
        paths:
          - /api/v2/comments/.*/replies
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        # No JWT plugin - public endpoint
      - name: tutorials-reply-create-route
        paths:
          - /api/v2/comments/.*/reply
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: tutorials-replies-update-route
        paths:
          - /api/v2/comments/.*/replies/.*
        methods:
          - PUT
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: tutorials-replies-delete-route
        paths:
          - /api/v2/comments/.*/replies/.*
        methods:
          - DELETE
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
      - name: tutorials-replies-interactions-route
        paths:
          - /api/v2/comments/.*/replies/.*/interactions
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
    plugins:
      - name: cors
      - name: rate-limiting
        config:
          minute: 100
          hour: 3000

  # ============================================================================
  # Notifications Service - Routes through gRPC Gateway
  # ============================================================================
  - name: notifications-service
    url: http://grpc-gateway:8080
    routes:
      - name: notifications-list-route
        paths:
          - /api/notifications
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: cors
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
          - name: rate-limiting
            config:
              minute: 100
              hour: 2000
      - name: notifications-get-route
        paths:
          - /api/notifications/.*
        methods:
          - GET
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: cors
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
          - name: rate-limiting
            config:
              minute: 100
              hour: 2000
      - name: notifications-mark-read-route
        paths:
          - /api/notifications/read/.*
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: cors
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
          - name: rate-limiting
            config:
              minute: 100
              hour: 2000
      - name: notifications-mark-all-read-route
        paths:
          - /api/notifications/read/all
        methods:
          - POST
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: cors
          - name: jwt
            config:
              uri_param_names:
                - token
              header_names:
                - Authorization
              cookie_names:
                - token
          - name: rate-limiting
            config:
              minute: 100
              hour: 2000

  # ============================================================================
  # Calendar Service - Routed through gRPC Gateway
  # ============================================================================
  # Calendar endpoints are public (no authentication required) except for /interact
  # All calendar requests are routed through grpc-gateway-service for REST to gRPC translation

  # Health Check Service - System Health Monitoring
  - name: health-check-service
    url: http://health-check-service:8090
    protocol: http
    routes:
      - name: health-check-route
        paths:
          - /health
          - /api/health
        methods:
          - GET
        strip_path: false
    plugins:
      - name: cors

  # Phase 5: Storage Service (File Uploads)
  # Public upload endpoint (no auth required)
  # Matches Laravel API: POST /api/upload
  - name: storage-service-upload
    url: http://storage-service:8059
    protocol: http
    routes:
      - name: upload-route
        paths:
          - /api/upload
        methods:
          - POST
          - OPTIONS
        strip_path: false  # Keep /api/upload path - storage service handles both /upload and /api/upload
    plugins:
      - name: cors
      - name: request-size-limiting
        config:
          allowed_payload_size: 100 # 100MB for file uploads
      - name: rate-limiting
        config:
          minute: 50
          hour: 1000

  # ============================================================================
  # Storage Service (Protected endpoints - auth required)
  # NOTE: Requires REST to gRPC translation layer - see docs/KONG_REST_TO_GRPC.md
  # ============================================================================
  - name: storage-service
    url: grpc://storage-service:50059
    protocol: grpc
    routes:
      - name: storage-routes
        paths:
          - /api/files
          - /api/images
        strip_path: false
        protocols:
          - http
          - https
    plugins:
      - name: cors
      - name: jwt
        config:
          uri_param_names:
            - token
          header_names:
            - Authorization
          cookie_names:
            - token
      - name: request-size-limiting
        config:
          allowed_payload_size: 100 # 100MB for file uploads
      - name: rate-limiting
        config:
          minute: 30
          hour: 500

# Global Plugins
plugins:
  # CORS for all services
  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - PATCH
        - OPTIONS
      headers:
        - Accept
        - Accept-Version
        - Content-Length
        - Content-MD5
        - Content-Type
        - Date
        - Authorization
      exposed_headers:
        - X-Auth-Token
        - X-Request-ID
      credentials: true
      max_age: 3600

  # Request ID tracking (removed - needs to be enabled in Kong config)
  # - name: request-id
  #   config:
  #     header_name: X-Request-ID
  #     generator: uuid
  #     echo_downstream: true

  # Response headers
  - name: response-transformer
    config:
      add:
        headers:
          - "X-Powered-By: MetaRGB Microservices"
          - "X-Version: 1.0.0"

  # Global rate limiting (per IP)
  - name: rate-limiting
    config:
      minute: 300
      hour: 10000
      policy: redis
      redis_host: redis
      redis_port: 6379
      fault_tolerant: true

# Upstreams for load balancing (if needed)
upstreams:
  - name: auth-service-upstream
    algorithm: round-robin
    hash_on: none
    targets:
      - target: auth-service:50051
        weight: 100

  - name: features-service-upstream
    algorithm: least-connections
    hash_on: consumer
    targets:
      - target: features-service:50053
        weight: 100

# Consumer management (for API keys if needed)
# Note: Consumer plugins should be configured at the service/route level, not consumer level
consumers:
  - username: admin
    custom_id: admin-user

