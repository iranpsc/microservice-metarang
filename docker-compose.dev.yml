# Development override for docker-compose.yml
# This file enables hot reloading by mounting source code as volumes
# Usage: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

# Development override for docker-compose.yml
# This file enables hot reloading by mounting source code as volumes
# Usage: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

services:
  # ============================================================================
  # Go Services - Hot Reloading with Air
  # ============================================================================
  
  auth-service:
    build:
      context: .
      dockerfile: ./services/auth-service/Dockerfile.dev
    volumes:
      - ./services/auth-service:/workspace/metargb/auth-service
      - ./shared:/workspace/metargb/shared
    command: sh -c "cd /workspace/metargb/auth-service && sed -i 's|replace metargb/shared => ../../shared|replace metargb/shared => /workspace/metargb/shared|g' go.mod && air -c /workspace/metargb/auth-service/.air.toml"

  grpc-gateway:
    build:
      context: .
      dockerfile: ./services/grpc-gateway/Dockerfile.dev
    volumes:
      - ./services/grpc-gateway:/workspace/metargb/grpc-gateway
      - ./shared:/workspace/metargb/shared
    command: sh -c "cd /workspace/metargb/grpc-gateway && sed -i 's|replace metargb/shared => ../../shared|replace metargb/shared => /workspace/metargb/shared|g' go.mod && air -c /workspace/metargb/grpc-gateway/.air.toml"

  commercial-service:
    build:
      context: .
      dockerfile: ./services/commercial-service/Dockerfile.dev
    volumes:
      - ./services/commercial-service:/workspace/metargb/commercial-service
      - ./shared:/workspace/metargb/shared
    command: sh -c "cd /workspace/metargb/commercial-service && sed -i 's|replace metargb/shared => ../../shared|replace metargb/shared => /workspace/metargb/shared|g' go.mod && air -c /workspace/metargb/commercial-service/.air.toml"

  features-service:
    build:
      context: .
      dockerfile: ./services/features-service/Dockerfile.dev
    volumes:
      - ./services/features-service:/workspace/metargb/features-service
      - ./shared:/workspace/metargb/shared
    command: sh -c "cd /workspace/metargb/features-service && sed -i 's|replace metargb/shared => ../../shared|replace metargb/shared => /workspace/metargb/shared|g' go.mod && air -c /workspace/metargb/features-service/.air.toml"

  levels-service:
    build:
      context: .
      dockerfile: ./services/levels-service/Dockerfile.dev
    volumes:
      - ./services/levels-service:/workspace/metargb/levels-service
      - ./shared:/workspace/metargb/shared
    command: sh -c "cd /workspace/metargb/levels-service && sed -i 's|replace metargb/shared => ../../shared|replace metargb/shared => /workspace/metargb/shared|g' go.mod && air -c /workspace/metargb/levels-service/.air.toml"

  dynasty-service:
    build:
      context: .
      dockerfile: ./services/dynasty-service/Dockerfile.dev
    volumes:
      - ./services/dynasty-service:/workspace/metargb/dynasty-service
      - ./shared:/workspace/metargb/shared
    command: sh -c "cd /workspace/metargb/dynasty-service && sed -i 's|replace metargb/shared => ../../shared|replace metargb/shared => /workspace/metargb/shared|g' go.mod && air -c /workspace/metargb/dynasty-service/.air.toml"

  calendar-service:
    build:
      context: .
      dockerfile: ./services/calendar-service/Dockerfile.dev
    volumes:
      - ./services/calendar-service:/workspace/metargb/calendar-service
      - ./shared:/workspace/metargb/shared
    command: sh -c "cd /workspace/metargb/calendar-service && sed -i 's|replace metargb/shared => ../../shared|replace metargb/shared => /workspace/metargb/shared|g' go.mod && air -c /workspace/metargb/calendar-service/.air.toml"

  support-service:
    build:
      context: .
      dockerfile: ./services/support-service/Dockerfile.dev
    volumes:
      - ./services/support-service:/workspace/metargb/support-service
      - ./shared:/workspace/metargb/shared
    command: sh -c "cd /workspace/metargb/support-service && sed -i 's|replace metargb/shared => ../../shared|replace metargb/shared => /workspace/metargb/shared|g' go.mod && air -c /workspace/metargb/support-service/.air.toml"

  notifications-service:
    build:
      context: .
      dockerfile: ./services/notifications-service/Dockerfile.dev
    volumes:
      - ./services/notifications-service:/workspace/metargb/notifications-service
      - ./shared:/workspace/metargb/shared
    command: sh -c "cd /workspace/metargb/notifications-service && sed -i 's|replace metargb/shared => ../../shared|replace metargb/shared => /workspace/metargb/shared|g' go.mod && air -c /workspace/metargb/notifications-service/.air.toml"

  storage-service:
    build:
      context: .
      dockerfile: ./services/storage-service/Dockerfile.dev
    volumes:
      - ./services/storage-service:/workspace/metargb/storage-service
      - ./shared:/workspace/metargb/shared
    command: sh -c "cd /workspace/metargb/storage-service && sed -i 's|replace metargb/shared => ../../shared|replace metargb/shared => /workspace/metargb/shared|g' go.mod && air -c /workspace/metargb/storage-service/.air.toml"

  financial-service:
    build:
      context: .
      dockerfile: ./services/financial-service/Dockerfile.dev
    volumes:
      - ./services/financial-service:/workspace/metargb/financial-service
      - ./shared:/workspace/metargb/shared
    command: sh -c "cd /workspace/metargb/financial-service && sed -i 's|replace metargb/shared => ../../shared|replace metargb/shared => /workspace/metargb/shared|g' go.mod && air -c /workspace/metargb/financial-service/.air.toml"

  # ============================================================================
  # Node.js Services - Hot Reloading with Nodemon
  # ============================================================================

  websocket-gateway:
    build:
      context: .
      dockerfile: ./websocket-gateway/Dockerfile.dev
    volumes:
      - ./websocket-gateway:/app
      - ./shared/proto:/app/shared/proto
      - /app/node_modules  # Anonymous volume to prevent overwriting node_modules
    command: npm run dev
    environment:
      NODE_ENV: development

# No additional volumes needed - .air.toml files are mounted via source code volumes